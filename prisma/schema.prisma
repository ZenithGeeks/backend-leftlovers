
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================ Enums ============================

enum Role {
  ADMIN
  MERCHANT
  CUSTOMER
  STAFF
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum MerchantStatus {
  PENDING
  APPROVED
  SUSPENDED
}

enum MenuItemStatus {
  DRAFT
  LIVE
  SOLD_OUT
  EXPIRED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  READY
  PICKED_UP
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum PromotionType {
  PERCENT
  FIXED
  BOGO
}

enum ComplaintType {
  EXPIRED
  QUALITY
  SIZE
  OTHER
}

enum ComplaintStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  REJECTED
}

enum WarningAction {
  WARN
  SUSPEND
}

enum Platform {
  IOS
  ANDROID
}

// Employee module
enum EmployeeRole {
  OWNER
  MANAGER
  CASHIER
  STOCK
}

enum OrderPreference {
  CONTACT
  REMOVE
  CANCELLED
}

enum EmployeeStatus {
  ACTIVE
  DISABLED
}

// ============================ Models ============================

model User {
  id            String          @id @default(uuid())
  role          Role
  name          String
  email         String          @unique
  phone         String?
  avatarUrl     String?
  status        UserStatus      @default(ACTIVE)
  createdAt     DateTime        @default(now())

  // Relations
  merchants     Merchant[]      @relation("UserMerchants")        // owner
  addresses     Address[]
  devices       Device[]
  notifications Notification[]
  reviews       Review[]
  complaints    Complaint[]
  auditLogs     AuditLog[]      @relation("ActorAuditLogs")
  employees     Employee[]      // optional link when staff uses the app

  @@index([role])
  Order Order[]
}

model Merchant {
  id            String          @id @default(uuid())
  ownerUserId   String
  displayName   String
  description   String?
  address       String?
  lat           Decimal?        @db.Decimal(10,7)
  lng           Decimal?        @db.Decimal(10,7)
  openHours     Json?
  isOpen        Boolean         @default(false)
  status        MerchantStatus  @default(PENDING)
  createdAt     DateTime        @default(now())

  owner         User            @relation(fields: [ownerUserId], references: [id], name: "UserMerchants", onDelete: Cascade)
  categories    Category[]
  menuItems     MenuItem[]
  promotions    Promotion[]
  orders        Order[]
  warnings      Warning[]
  employees     Employee[]

  @@index([ownerUserId])
  @@index([status])
}

model Category {
  id         String      @id @default(uuid())
  merchantId String
  parentId   String?
  name       String

  merchant   Merchant    @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  parent     Category?   @relation("CategoryToSelf", fields: [parentId], references: [id])
  children   Category[]  @relation("CategoryToSelf")
  menuItems  MenuItem[]

  @@index([merchantId])
  @@index([parentId])
  @@unique([merchantId, name]) // category name unique per merchant
}

model MenuItem {
  id            String          @id @default(uuid())
  merchantId    String
  categoryId    String?
  name          String
  description   String?
  basePrice     Decimal         @db.Decimal(10,2)
  originalPrice Decimal?        @db.Decimal(10,2)
  leftoverQty   Int             @default(0)
  expiresAt     DateTime?
  status        MenuItemStatus  @default(DRAFT)
  createdAt     DateTime        @default(now())
  photoUrl      String?

  merchant      Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  category      Category?       @relation(fields: [categoryId], references: [id])
  optionGroups  OptionGroup[]
  orderItems    OrderItem[]
  inventoryLogs InventoryLog[]

  @@index([merchantId])
  @@index([categoryId])
  @@index([status, expiresAt])
}

model OptionGroup {
  id          String     @id @default(uuid())
  menuItemId  String
  name        String
  minSelect   Int        @default(0)
  maxSelect   Int        @default(1)
  sortOrder   Int        @default(0)

  menuItem    MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  options     Option[]

  @@unique([menuItemId, name])
  @@index([menuItemId])
}

model Option {
  id             String      @id @default(uuid())
  optionGroupId  String
  name           String
  priceDelta     Decimal     @db.Decimal(10,2)
  sortOrder      Int         @default(0)
  active         Boolean     @default(true)
  group          OptionGroup @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)
  orderChoices   OrderItemOption[]

  @@unique([optionGroupId, name])
  @@index([optionGroupId])
}

model Order {
  id             String        @id @default(uuid())
  customerId     String
  merchantId     String
  status         OrderStatus   @default(PENDING)
  subtotal       Decimal       @db.Decimal(10,2)
  discountTotal  Decimal       @db.Decimal(10,2) @default(0)
  totalAmount    Decimal       @db.Decimal(10,2)
  paymentStatus  PaymentStatus @default(UNPAID)
  pickupCode     String?       @unique
  pickupDeadline DateTime?
  createdAt      DateTime      @default(now())
  preference     OrderPreference       @default(CONTACT)
  note           String?

  customer       User          @relation(fields: [customerId], references: [id])
  merchant       Merchant      @relation(fields: [merchantId], references: [id])
  items          OrderItem[]
  payment        Payment?
  promoUsages    PromotionUsage[]
  inventoryLogs  InventoryLog[]
  review         Review?
  complaint      Complaint?

  @@index([customerId, createdAt])
  @@index([merchantId, status])
}

model OrderItem {
  id          String    @id @default(uuid())
  orderId     String
  menuItemId  String
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10,2)
  lineTotal   Decimal   @db.Decimal(10,2)

  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id])
  options     OrderItemOption[]

  @@index([orderId])
  @@index([menuItemId])
}

model OrderItemOption {
  id            String   @id @default(uuid())
  orderItemId   String
  optionId      String
  priceDelta    Decimal  @db.Decimal(10,2)

  orderItem     OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  option        Option    @relation(fields: [optionId], references: [id])

  @@unique([orderItemId, optionId])
  @@index([optionId])
}

model Payment {
  id                 String        @id @default(uuid())
  orderId            String        @unique
  merchantId         String  
  provider           String        // omise | stripe | cash
  providerChargeId   String?
  amount             Decimal       @db.Decimal(10,2)
  currency           String        @default("THB")
  status             PaymentStatus @default(UNPAID)
  paidAt             DateTime?

  order              Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Promotion {
  id           String        @id @default(uuid())
  merchantId   String
  name         String
  type         PromotionType
  value        Decimal       @db.Decimal(10,2)
  minOrder     Decimal?      @db.Decimal(10,2)
  usageLimit   Int?
  startAt      DateTime?
  endAt        DateTime?
  active       Boolean       @default(false)

  merchant     Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  usages       PromotionUsage[]

  @@unique([merchantId, name])
  @@index([merchantId, active])
}

model PromotionUsage {
  id              String    @id @default(uuid())
  promotionId     String
  orderId         String    @unique
  discountAmount  Decimal   @db.Decimal(10,2)

  promotion       Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([promotionId])
}

model InventoryLog {
  id          String   @id @default(uuid())
  menuItemId  String
  orderId     String?
  change      Int
  reason      String   // order | manual | correction | expiry
  createdAt   DateTime @default(now())

  menuItem    MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  order       Order?   @relation(fields: [orderId], references: [id])

  @@index([menuItemId, createdAt])
  @@index([orderId])
}

model Review {
  id          String   @id @default(uuid())
  orderId     String   @unique
  customerId  String
  rating      Int
  comment     String?
  tags        String?  // "freshness,portion"
  createdAt   DateTime @default(now())

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  customer    User     @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model Complaint {
  id          String          @id @default(uuid())
  orderId     String          @unique
  customerId  String
  type        ComplaintType
  description String?
  status      ComplaintStatus @default(OPEN)
  createdAt   DateTime        @default(now())

  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  customer    User            @relation(fields: [customerId], references: [id])
  warning     Warning?

  @@index([customerId, status])
}

model Warning {
  id              String        @id @default(uuid())
  merchantId      String
  complaintId     String?       @unique
  suspensionDays  Int?
  issuedAt        DateTime      @default(now())
  expiresAt       DateTime?

  merchant        Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  complaint       Complaint?    @relation(fields: [complaintId], references: [id])

  @@index([merchantId])
  @@index([complaintId])
}

model Address {
  id         String   @id @default(uuid())
  userId     String
  label      String?
  line1      String
  line2      String?
  city       String?
  province   String?
  postalCode String?
  lat        Decimal? @db.Decimal(10,7)
  lng        Decimal? @db.Decimal(10,7)

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Device {
  id         String    @id @default(uuid())
  userId     String
  platform   Platform
  pushToken  String?
  createdAt  DateTime  @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, platform])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String?
  action      String
  targetType  String
  targetId    String?
  meta        Json?
  createdAt   DateTime @default(now())

  actor       User?    @relation(fields: [actorUserId], references: [id], name: "ActorAuditLogs", onDelete: SetNull)

  @@index([actorUserId, createdAt])
}

// ===================== Employee Management ======================

model Employee {
  id            String         @id @default(uuid())
  merchantId    String
  userId        String?        // link to User if they sign in
  fullName      String
  username      String?        @unique
  email         String?
  mobileNumber  String?
  role          EmployeeRole   @default(STOCK)
  status        EmployeeStatus @default(ACTIVE)
  createdAt     DateTime       @default(now())
  disabledAt    DateTime?

  merchant      Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user          User?          @relation(fields: [userId], references: [id])

  @@index([merchantId])
  @@index([role, status])
}


generator erd {
  provider = "prisma-erd-generator"
  output   = "./ERD.svg"
}