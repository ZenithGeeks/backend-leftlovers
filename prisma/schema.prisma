generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MERCHANT
  CUSTOMER
  STAFF
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum MerchantStatus {
  PENDING
  APPROVED
  SUSPENDED
}

enum MenuItemStatus {
  DRAFT
  LIVE
  SOLD_OUT
  EXPIRED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  READY
  PICKED_UP
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum PromotionType {
  PERCENT
  FIXED
  BOGO
}

enum ComplaintType {
  EXPIRED
  QUALITY
  SIZE
  OTHER
}

enum ComplaintStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  REJECTED
}

enum WarningAction {
  WARN
  SUSPEND
}

enum Platform {
  IOS
  ANDROID
}

enum EmployeeRole {
  OWNER
  MANAGER
  CASHIER
  STOCK
}

enum OrderPreference {
  CONTACT
  REMOVE
  CANCELLED
}

enum EmployeeStatus {
  ACTIVE
  DISABLED
}

model User {
  id            String          @id @default(uuid())
  role          Role
  name          String
  email         String          @unique
  phone         String?
  dob           DateTime
  avatarUrl     String?
  status        UserStatus      @default(ACTIVE)
  createdAt     DateTime        @default(now())

  merchants     Merchant[]
  orders        Order[]
  notifications Notification[]
  employee      Employee?
  favorites     Favorite[]

  @@index([role])
}

model Merchant {
  id            String          @id @default(uuid())
  ownerUserId   String
  displayName   String
  branchName    String?
  description   String?
  categoryId    String
  addressId     String
  openHours     Json?
  status        MerchantStatus  @default(PENDING)
  createdAt     DateTime        @default(now())

  user          User            @relation(fields: [ownerUserId], references: [id], onDelete: Restrict)
  address       Address         @relation(fields: [addressId], references: [id], onDelete: Cascade)
  category      Category        @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  menuItems     MenuItem[]
  orders        Order[]
  promotions    Promotion[]
  warnings      Warning[]
  employees     Employee[]
  favorite      Favorite[]
  optionGroups  OptionGroup[]
  payments      Payment[]

  @@index([ownerUserId])
  @@index([status])
}

model Category {
  id         String      @id @default(uuid())
  name       String

  merchants  Merchant[]

  @@unique([name])
}

model MenuItem {
  id            String          @id @default(uuid())
  merchantId    String
  name          String
  description   String?
  basePrice     Decimal         @db.Decimal(10,2)
  originalPrice Decimal?        @db.Decimal(10,2)
  leftoverQty   Int             @default(0)
  expiresAt     DateTime
  status        MenuItemStatus  @default(DRAFT)
  createdAt     DateTime        @default(now())
  photoUrl      String?
  expireLabelUrl String?

  merchant      Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  optionGroups  OptionGroup[]
  inventoryLogs InventoryLog[]

  @@index([merchantId])
  @@index([status, expiresAt])
}

model OptionGroup {
  id          String     @id @default(uuid())
  merchantId  String
  name        String
  minSelect   Int        @default(0)
  maxSelect   Int        @default(1)

  merchant    Merchant   @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  options     Option[]
  menuItems   MenuItem[]

  @@unique([name])
}

model Option {
  id             String      @id @default(uuid())
  optionGroupId  String
  name           String
  priceDelta     Decimal     @db.Decimal(10,2)
  active         Boolean     @default(true)

  optionGroup    OptionGroup @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)
  orderItemOption     OrderItemOption[]

  @@unique([optionGroupId, name])
  @@index([optionGroupId])
}

model Order {
  id             String        @id @default(uuid())
  customerId     String
  merchantId     String
  status         OrderStatus   @default(PENDING)
  subtotal       Decimal       @db.Decimal(10,2)
  discountTotal  Decimal       @db.Decimal(10,2) @default(0)
  totalAmount    Decimal       @db.Decimal(10,2)
  paymentStatus  PaymentStatus @default(UNPAID)
  pickupCode     String        @unique
  pickupDeadline DateTime
  createdAt      DateTime      @default(now())
  preference     OrderPreference       @default(CONTACT)
  note           String?

  user           User          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  merchant       Merchant      @relation(fields: [merchantId], references: [id], onDelete: Restrict)
  orderItems     OrderItem[]
  payment        Payment?
  promotionUsages         PromotionUsage[]
  review         Review?
  complaint      Complaint?
  inventoryLogs  InventoryLog[]

  @@index([customerId, createdAt])
  @@index([merchantId, status])
}

model OrderItem {
  id          String    @id @default(uuid())
  orderId     String
  menuItemId  String
  quantity    Int

  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Restrict)
  orderItemOptions OrderItemOption[]

  @@index([orderId])
  @@index([menuItemId])
}

model OrderItemOption {
  id            String   @id @default(uuid())
  orderItemId   String
  optionId      String

  orderItem     OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  option        Option    @relation(fields: [optionId], references: [id], onDelete: Restrict)

  @@unique([orderItemId, optionId])
  @@index([optionId])
}

model Payment {
  id                 String        @id @default(uuid())
  orderId            String        @unique
  merchantId         String
  provider           String
  providerChargeId   String
  amount             Decimal       @db.Decimal(10,2)
  currency           String        @default("THB")
  status             PaymentStatus @default(UNPAID)
  paidAt             DateTime?

  order              Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  merchant           Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
}

model Promotion {
  id           String        @id @default(uuid())
  merchantId   String
  name         String
  type         PromotionType
  value        Decimal       @db.Decimal(10,2)
  minOrder     Decimal?      @db.Decimal(10,2)
  usageLimit   Int?
  startAt      DateTime?
  endAt        DateTime?
  active       Boolean       @default(false)

  merchant     Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  promotionUsages       PromotionUsage[]

  @@unique([merchantId, name])
  @@index([merchantId, active])
}

model PromotionUsage {
  id              String    @id @default(uuid())
  promotionId     String
  orderId         String    @unique
  discountAmount  Decimal   @db.Decimal(10,2)

  promotion       Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([promotionId])
}

model InventoryLog {
  id          String   @id @default(uuid())
  menuItemId  String
  orderId     String?
  change      Int
  reason      String
  createdAt   DateTime @default(now())

  menuItem    MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  order       Order?   @relation(fields: [orderId], references: [id])

  @@index([menuItemId, createdAt])
  @@index([orderId])
}

model Review {
  id          String   @id @default(uuid())
  orderId     String   @unique
  rating      Int
  comment     String?
  createdAt   DateTime @default(now())

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Restrict)
}

model Complaint {
  id          String          @id @default(uuid())
  orderId     String          @unique
  type        ComplaintType
  description String?
  status      ComplaintStatus @default(OPEN)
  createdAt   DateTime        @default(now())

  order       Order           @relation(fields: [orderId], references: [id], onDelete: Restrict)
  warning     Warning?

  @@index([status])
}

model Warning {
  id              String        @id @default(uuid())
  merchantId      String
  complaintId     String        @unique
  suspensionDays  Int?
  issuedAt        DateTime      @default(now())

  merchant        Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  complaint       Complaint     @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([complaintId])
}

model Address {
  id         String   @id @default(uuid())
  line1      String
  line2      String?
  city       String?
  province   String?
  postalCode String?
  lat        Decimal? @db.Decimal(10,7)
  lng        Decimal? @db.Decimal(10,7)

  merchants  Merchant[]
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Employee {
  id            String         @id @default(uuid())
  merchantId    String
  userId        String         @unique
  role          EmployeeRole   @default(STOCK)
  status        EmployeeStatus @default(ACTIVE)
  createdAt     DateTime       @default(now())
  disabledAt    DateTime?

  merchant      Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([role, status])
}

model Favorite {
    userId      String
    merchantId  String

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    merchant    Merchant    @relation(fields: [merchantId], references: [id], onDelete: Cascade)

    @@id([userId, merchantId])
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "./ERD.svg"
}